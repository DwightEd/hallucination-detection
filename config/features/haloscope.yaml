# =============================================================================
# Feature Extraction Configuration - For HaloScope Method (修正版)
# =============================================================================
# 
# ⚠️ 重要修正说明：
# 
# 原始HaloScope的特征提取方式：
# 1. 将问题前置于生成的答案: [Question] + [Answer]
# 2. 提取完整序列最后一个token的hidden state
# 3. 使用中间层 (8-14层)
# 4. 不对token做任何pooling
# 
# 论文原文: "we prepend the question to the generated answer and use 
# the last-token embedding to identify the subspace"
# =============================================================================

mode: teacher_forcing

# 存储策略: 保留完整hidden states以便后续处理
stored_features: hidden_states_full

# =============================================================================
# 注意力特征 (HaloScope不需要)
# =============================================================================
attention_enabled: false
attention_layers: none
attention_storage: none
store_full_attention: false

# =============================================================================
# 隐藏状态特征 - HaloScope 关键配置
# =============================================================================

hidden_states_enabled: true

# ⚠️ 修正: 提取所有层，让方法自己选择
# HaloScope需要中间层(8-14)，但我们提取所有层以保持灵活性
hidden_states_layers: all

# ⚠️ 关键修正: 不池化！
# HaloScope使用last token，但池化应该在方法内部处理
# 这里保留完整序列: [n_layers, seq_len, hidden_dim]
hidden_states_pooling: none

# =============================================================================
# Token概率特征 (HaloScope不需要)
# =============================================================================
token_probs_enabled: false
token_probs_top_k: 10

# =============================================================================
# 长度和批次限制
# =============================================================================

# ⚠️ 注意: 此值应与 default.yaml 或 params.yaml 中的值保持一致
# Hydra配置优先级: 命令行 > params.yaml > features/xxx.yaml > features/default.yaml
# 建议在 params.yaml 中统一管理此值
max_length: 8192
batch_size: 2

# =============================================================================
# 高级选项
# =============================================================================
use_fp16: true
clear_cache_per_sample: true
checkpoint_interval: 50

# =============================================================================
# HaloScope特定说明
# =============================================================================
# 
# 特征提取后，HaloScope方法会：
# 1. 选择中间层 (layer_selection: middle)
# 2. 只提取最后一个token的embedding (token_selection: last)
# 3. 将多层embedding展平为一个特征向量
# 
# 最终特征维度: n_selected_layers × hidden_dim
# 例如: 7层 × 4096 = 28672维
# =============================================================================