# =============================================================================
# Main Hydra Configuration
# =============================================================================
# 所有参数可通过命令行覆盖
# 
# 目录结构:
#   features: {features_dir}/{dataset}/{model}/seed_{seed}/{task_type}/
#   models:   {models_dir}/{dataset}/{model}/seed_{seed}/{task_type}/{method}/probe/
# 
# 使用示例:
#   python scripts/generate_activations.py dataset.name=ragtruth model=qwen2.5_7b
#   python scripts/generate_activations.py dataset.models=[gpt-4] methods=[lapeigvals,haloscope]
#   python scripts/generate_activations.py features=with_full_attentions allow_full_attention=true
# =============================================================================

# =============================================================================
# 默认配置组
# =============================================================================

defaults:
  # -------------------------------------------------------------------------
  # 数据集配置 (config/dataset/)
  # 可选: ragtruth, halueval, truthfulqa
  # -------------------------------------------------------------------------
  - dataset: ragtruth
  
  # -------------------------------------------------------------------------
  # 模型配置 (config/model/)
  # 可选: mistral_7b, llama3_8b, qwen2.5_7b, qwen2.5_7b_4bit
  # -------------------------------------------------------------------------
  - model: mistral_7b
  
  # -------------------------------------------------------------------------
  # 方法配置 (config/method/)
  # 可选: lapeigvals, entropy, hypergraph, lookback_lens, 
  #       haloscope, hsdmvaf, ensemble, auto_ensemble
  # -------------------------------------------------------------------------
  - method: lapeigvals
  
  # -------------------------------------------------------------------------
  # 特征提取配置 (config/features/)
  # 可选: 
  #   - default: 内存优化，不存储完整注意力（推荐）
  #   - with_full_attentions: 存储完整注意力（需要大显存）
  #   - lapeigvals: 针对lapeigvals方法优化
  # -------------------------------------------------------------------------
  - features: default
  
  # -------------------------------------------------------------------------
  # 生成配置 (config/generation/)
  # -------------------------------------------------------------------------
  - generation: default
  
  # -------------------------------------------------------------------------
  # 提示模板配置 (config/prompt/)
  # -------------------------------------------------------------------------
  - prompt: ragtruth
  
  - _self_

# =============================================================================
# 全局设置
# =============================================================================

# 随机种子（用于可复现性）
seed: 42

# =============================================================================
# 目录配置
# =============================================================================

# 项目根目录
base_dir: .

# 数据目录
data_dir: /share/home/tm902089733300000/a903202310/lys/data/RAGTruth/dataset

# 特征输出目录
features_dir: ${base_dir}/outputs/features

# 模型保存目录
models_dir: ${base_dir}/outputs/models

# 结果输出目录
results_dir: ${base_dir}/outputs/results

# =============================================================================
# 日志配置
# =============================================================================

log_level: INFO

# =============================================================================
# 高级选项
# =============================================================================

# -------------------------------------------------------------------------
# 方法列表（用于特征需求计算）
# 
# 当指定多个方法时，FeatureManager会计算所有方法需求的并集
# 这确保一次特征提取可以满足所有方法的需要
#
# 默认包含四个方法: lapeigvals, lookback_lens, haloscope, hsdmvaf
# 示例: [lapeigvals, haloscope] 会提取两个方法所需的所有特征
# -------------------------------------------------------------------------
methods:
  - lapeigvals
  - lookback_lens
  - haloscope
  - hsdmvaf

# -------------------------------------------------------------------------
# 是否从检查点恢复
# 
# true (默认): 检查 features_individual/ 中已存在的特征文件
#              - 如果样本全部齐全 → 跳过特征提取
#              - 如果有缺失 → 只提取缺失的样本
# false: 强制重新提取所有特征
# -------------------------------------------------------------------------
resume: true

# -------------------------------------------------------------------------
# ⚠️ 完整注意力控制 (CRITICAL)
#
# 是否允许提取完整注意力矩阵
# 
# 即使特征配置或方法需要full_attention，也必须设此选项为true才会启用
# 这是一个安全开关，防止意外OOM
#
# hsdmvaf 方法需要 full_attention 以获得最佳效果
# 设为 true 时，内存需求增加但不会太大（因为 hsdmvaf 只使用最后4层）
#
# 仅在以下情况设为true：
# 1. 使用 hypergraph 或 hsdmvaf 方法
# 2. 有足够GPU显存
# -------------------------------------------------------------------------
allow_full_attention: true

# =============================================================================
# 模型配置覆盖
# =============================================================================

model:
  # 输出路径使用的短名称 (null = 自动生成)
  short_name: null
  
  # -------------------------------------------------------------------------
  # 多GPU配置示例（取消注释以启用）
  # -------------------------------------------------------------------------
  # multi_gpu:
  #   enabled: true
  #   strategy: auto
  #   max_memory:
  #     0: "20GB"
  #     1: "20GB"

# =============================================================================
# 命令行使用示例
# =============================================================================
#
# 1. 基本使用（使用所有默认方法）:
#    python scripts/generate_activations.py
#
# 2. 指定数据集和模型:
#    python scripts/generate_activations.py dataset=ragtruth model=qwen2.5_7b
#
# 3. 按源模型过滤数据:
#    python scripts/generate_activations.py dataset.models=[gpt-4]
#
# 4. 自定义方法列表:
#    python scripts/generate_activations.py methods=[lapeigvals,haloscope]
#
# 5. 启用完整注意力（hsdmvaf/hypergraph方法）:
#    python scripts/generate_activations.py \
#        methods=[hsdmvaf] \
#        features=with_full_attentions \
#        allow_full_attention=true
#
# 6. 多GPU加载:
#    python scripts/generate_activations.py \
#        model.multi_gpu.enabled=true \
#        model.multi_gpu.strategy=balanced
#
# 7. 4bit量化（节省显存）:
#    python scripts/generate_activations.py model=qwen2.5_7b_4bit
#
# 8. 快速测试（限制样本数）:
#    python scripts/generate_activations.py dataset.max_samples=100
#
# =============================================================================
